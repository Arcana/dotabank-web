{% extends "layout.html" %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for("static", filename="js/Chart.js") }}" charset="utf-8"></script>
    <script>
        {% set graph_fill_colours = [
            "rgba( 64, 100, 255, .1)",
            "rgba( 64, 222, 142, .1)",
            "rgba(144,   8, 185, .1)",
            "rgba(243, 240,  11, .1)",
            "rgba(255, 107,   0, .1)",
            "rgba(254, 134, 197, .1)",
            "rgba(179, 181, 191, .1)",
            "rgba(101, 217, 247, .1)",
            "rgba( 96, 243,  11, .1)",
            "rgba(120,  77,   0, .1)"
        ] %}
        {% set graph_stroke_colours = [
            "rgba( 64, 100, 255, .5)",
            "rgba( 64, 222, 142, .5)",
            "rgba(144,   8, 185, .5)",
            "rgba(243, 240,  11, .5)",
            "rgba(255, 107,   0, .5)",
            "rgba(254, 134, 197, .5)",
            "rgba(179, 181, 191, .5)",
            "rgba(101, 217, 247, .5)",
            "rgba( 96, 243,  11, .5)",
            "rgba(120,  77,   0, .5)"
        ] %}

        {% set radiant_fill_colour = "rgba(0, 100, 0, 0.5)" %}
        {% set radiant_stroke_colour = "rgba(0, 100, 0, 1)" %}
        {% set dire_fill_colour = "rgba(255, 0, 0, 0.25)" %}
        {% set dire_stroke_colour = "rgba(255, 0, 0, 1)" %}
        {% if graph_data %}


        new Chart(
            $("#graph-gold-canvas").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},

                datasets: [
                    {% for team in graph_teams %}
                    {
                    fillColor : "{{ radiant_fill_colour if team == "radiant" else dire_fill_colour }}",
                    strokeColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in graph_teams[team]|map(attribute="gold") %}{{ item|int }},{% endfor %}]
                    },
                    {% endfor %}
                ]
            }
        );
        {% for player in graph_data %}
        new Chart(
            $("#graph-gold-canvas-{{ player.id }}").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},
                datasets: [
                    {
                    fillColor : "{{ graph_fill_colours[player.player_snapshots[0].index] }}",
                    strokeColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in player.player_snapshots|map(attribute="earned_gold") %}{{ item|int }},{% endfor %}]
                    },
                ]
            }
        );
        {% endfor %}

        new Chart(
            $("#graph-exp-canvas").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},

                datasets: [
                    {% for team in graph_teams %}
                    {
                    fillColor : "{{ radiant_fill_colour if team == "radiant" else dire_fill_colour }}",
                    strokeColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in graph_teams[team]|map(attribute="exp") %}{{ item|int }},{% endfor %}]
                    },
                    {% endfor %}
                ]
            }
        );
        {% for player in graph_data %}
        new Chart(
            $("#graph-exp-canvas-{{ player.id }}").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},
                datasets: [
                    {
                    fillColor : "{{ graph_fill_colours[player.player_snapshots[0].index] }}",
                    strokeColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in player.player_snapshots|map(attribute="xp") %}{{ item|int }},{% endfor %}]
                    },
                ]
            }
        );
        {% endfor %}

        new Chart(
            $("#graph-lh-canvas").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},

                datasets: [
                    {% for team in graph_teams %}
                    {
                    fillColor : "{{ radiant_fill_colour if team == "radiant" else dire_fill_colour }}",
                    strokeColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in graph_teams[team]|map(attribute="lh") %}{{ item|int }},{% endfor %}]
                    },
                    {% endfor %}
                ]
            }
        );
        {% for player in graph_data %}
        new Chart(
            $("#graph-lh-canvas-{{ player.id }}").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},
                datasets: [
                    {
                    fillColor : "{{ graph_fill_colours[player.player_snapshots[0].index] }}",
                    strokeColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in player.player_snapshots|map(attribute="last_hits") %}{{ item|int }},{% endfor %}]
                    },
                ]
            }
        );
        {% endfor %}

        new Chart(
            $("#graph-dn-canvas").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},

                datasets: [
                    {% for team in graph_teams %}
                    {
                    fillColor : "{{ radiant_fill_colour if team == "radiant" else dire_fill_colour }}",
                    strokeColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointColor : "{{ radiant_stroke_colour if team == "radiant" else dire_stroke_colour }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in graph_teams[team]|map(attribute="dn") %}{{ item|int }},{% endfor %}]
                    },
                    {% endfor %}
                ]
            }
        );
        {% for player in graph_data %}
        new Chart(
            $("#graph-dn-canvas-{{ player.id }}").get(0).getContext("2d")).Line(
            {
                labels: {{ graph_labels }},
                datasets: [
                    {
                    fillColor : "{{ graph_fill_colours[player.player_snapshots[0].index] }}",
                    strokeColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointColor : "{{ graph_stroke_colours[player.player_snapshots[0].index] }}",
                    pointStrokeColor : "#fff",
                    data: [{% for item in player.player_snapshots|map(attribute="denies") %}{{ item|int }},{% endfor %}]
                    },
                ]
            }
        );
        {% endfor %}
        {% endif %}
    </script>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Replay <small>{{ replay.id }}</small></h1>
        {% include "replays/replay_nav.html" %}
    </div>


{#    state = db.Column(db.Enum(#}
{#        "WAITING_GC",#}
{#        "WAITING_DOWNLOAD",#}
{#        "DOWNLOAD_IN_PROGRESS",#}
{#        "WAITING_PARSE",#}
{#        "PARSE_IN_PROGRESS",#}
{#        "PARSED",#}
{#        "GC_ERROR",#}
{#        "PARSE_ERROR"#}
{#    ), default="WAITING_GC")#}

    {% if replay.state == "parsed" %}
        <div class="alert alert-info">PARSED!</div>
    {% elif replay.state in ["WAITING_GC", "WAITING_DOWNLOAD", "DOWNLOAD_IN_PROGRESS", "WAITING_PARSE", "PARSE_IN_PROGRESS"] %}
        {% if replay.state == "WAITING_DOWNLOAD" and replay.replay_state != "REPLAY_AVAILABLE" %}
            <div class="alert alert-danger"><strong>Welp.</strong> The replay is not available ({{ replay.replay_state }}), we can't do anything special with it. :(</div>
        {% else %}
            <div class="alert alert-warning"><strong>I'm not ready!</strong> The replay is in limbo ({{ replay.state }}), check back soon.</div>
        {% endif %}
    {% elif replay.state in ["GC_ERROR", "PARSE_ERROR"] %}
        <div class="alert alert-danger">
            <strong>Sorry!</strong>
            {% if replay.state == "GC_ERROR" %}
                There was a problem retrieving match details, this could be because the match was private, requires a tournament pass to access, or the match id is invalid.
            {% else %}
                There was a problem parsing this matches' replay; it has been reported to the site admins to investigate.
            {% endif %}
        </div>
    {% endif %}

    <div class="tab-pane active" id="overview">
        <dl class="dl-horizontal">
            <dt>id</dt>
            <dd>{{ replay.id }}</dd>
            <dt>url</dt>
            <dd>{{ replay.url }}</dd>
            <dt>state</dt>
            <dd>{{ replay.state }}</dd>
            <dt>replay_state</dt>
            <dd>{{ replay.replay_state }}</dd>
            <dt>ratings</dt>
            <dd>{{ replay.ratings }}</dd>
        </dl>
    </div>


    {% if graph_data %}
    <h2>Charts</h2>
    <ul class="nav nav-tabs">
        <li class="active"><a href="#graph-gold" data-toggle="tab">Gold</a></li>
        <li><a href="#graph-exp" data-toggle="tab">Experience</a></li>
        <li><a href="#graph-lh" data-toggle="tab">Last hits</a></li>
        <li><a href="#graph-dn" data-toggle="tab">Denies</a></li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="graph-gold">
            <h3>Total</h3>
            <canvas id="graph-gold-canvas" width="1140" height="400"></canvas>
            {% for player in graph_data %}
                <h3>{{ player.player_snapshots[-1].hero_name }}</h3>
                <canvas id="graph-gold-canvas-{{ player.id }}" width="1140" height="400"></canvas>
            {% endfor %}
        </div>
        <div class="tab-pane" id="graph-exp">
            <canvas id="graph-exp-canvas" width="1140" height="400"></canvas>
            {% for player in graph_data %}
                <h3>{{ player.player_snapshots[-1].hero_name }}</h3>
                <canvas id="graph-exp-canvas-{{ player.id }}" width="1140" height="400"></canvas>
            {% endfor %}
        </div>
        <div class="tab-pane" id="graph-lh">
            <canvas id="graph-lh-canvas" width="1140" height="400"></canvas>
            {% for player in graph_data %}
                <h3>{{ player.player_snapshots[-1].hero_name }}</h3>
                <canvas id="graph-lh-canvas-{{ player.id }}" width="1140" height="400"></canvas>
            {% endfor %}
        </div>
        <div class="tab-pane" id="graph-dn">
            <canvas id="graph-dn-canvas" width="1140" height="400"></canvas>
            {% for player in graph_data %}
                <h3>{{ player.player_snapshots[-1].hero_name }}</h3>
                <canvas id="graph-dn-canvas-{{ player.id }}" width="1140" height="400"></canvas>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endblock %}
